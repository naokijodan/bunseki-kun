<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ぶんせき君 - eBay分析</title>
  <link rel="stylesheet" href="popup.css">
</head>
<body>
  <div class="app-container">
    <!-- ヘッダー -->
    <header class="app-header">
      <div class="header-left">
        <span class="app-icon">🔶</span>
        <h1 class="app-title">ぶんせき君</h1>
        <span class="version-badge">v4.0</span>
      </div>
      <div class="header-right">
        <button id="settingsBtn" class="icon-btn" title="設定">
          <span>⚙️</span>
        </button>
      </div>
    </header>

    <!-- メインタブ -->
    <nav class="main-tabs">
      <button class="main-tab active" data-tab="data-input">
        <span class="tab-icon">📥</span>
        <span class="tab-label">データ入力</span>
      </button>
      <button class="main-tab" data-tab="analysis">
        <span class="tab-icon">📊</span>
        <span class="tab-label">分析</span>
      </button>
      <button class="main-tab" data-tab="ai-suggestions">
        <span class="tab-icon">🤖</span>
        <span class="tab-label">AI提案</span>
      </button>
    </nav>

    <!-- メインコンテンツ -->
    <main class="main-content">

      <!-- ===================== -->
      <!-- データ入力タブ -->
      <!-- ===================== -->
      <section id="data-input-tab" class="tab-content active">

        <!-- 自分のデータセクション -->
        <div class="data-section">
          <div class="section-header">
            <h2><span class="section-icon">📦</span> 自分のデータ</h2>
          </div>

          <div class="data-cards">
            <!-- Active Listings -->
            <div class="data-card">
              <div class="data-card-header">
                <span class="data-card-icon">📋</span>
                <span class="data-card-title">Active Listings</span>
              </div>
              <div class="data-card-body">
                <div class="file-upload-area" id="activeListingsUpload">
                  <input type="file" id="activeListingsFile" accept=".csv" hidden>
                  <label for="activeListingsFile" class="file-upload-label">
                    <span class="upload-icon">📁</span>
                    <span class="upload-text">CSVを選択</span>
                  </label>
                </div>
                <div class="data-status" id="activeListingsStatus">
                  <span class="status-icon">⏳</span>
                  <span class="status-text">未読み込み</span>
                </div>
              </div>
            </div>

            <!-- Orders -->
            <div class="data-card">
              <div class="data-card-header">
                <span class="data-card-icon">💰</span>
                <span class="data-card-title">Orders (売上)</span>
              </div>
              <div class="data-card-body">
                <div class="file-upload-area" id="ordersUpload">
                  <input type="file" id="ordersFile" accept=".csv" hidden>
                  <label for="ordersFile" class="file-upload-label">
                    <span class="upload-icon">📁</span>
                    <span class="upload-text">CSVを選択</span>
                  </label>
                </div>
                <div class="data-status" id="ordersStatus">
                  <span class="status-icon">⏳</span>
                  <span class="status-text">未読み込み</span>
                </div>
              </div>
            </div>
          </div>

          <!-- 自分のデータサマリー -->
          <div class="data-summary" id="myDataSummary" style="display: none;">
            <div class="summary-item">
              <span class="summary-label">出品中</span>
              <span class="summary-value" id="myActiveCount">0</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">売却済</span>
              <span class="summary-value" id="mySoldCount">0</span>
            </div>
          </div>

          <!-- 自分のデータ操作ボタン -->
          <div class="my-data-actions" id="myDataActions" style="display: none;">
            <button id="analyzeMyDataBtn" class="action-btn primary">
              <span class="btn-icon">🔍</span>
              分析する
            </button>
            <button id="clearMyDataBtn" class="action-btn danger small">
              <span class="btn-icon">🗑️</span>
              データクリア
            </button>
            <button id="clearMyAnalysisBtn" class="action-btn secondary small">
              <span class="btn-icon">🔄</span>
              分析結果クリア
            </button>
          </div>

          <!-- 自分のデータ分析結果 -->
          <div id="myDataAnalysisResult" class="data-analysis-result" style="display: none;">
            <div class="analysis-result-header">
              <h3>📊 分析結果</h3>
              <span class="save-status" id="myDataSaveStatus">
                <span class="save-icon">💾</span>
                <span class="save-text">自動保存済み</span>
              </span>
            </div>
            <div class="analysis-stats">
              <div class="stat-box classified">
                <span class="stat-icon">✅</span>
                <span class="stat-label">分類済み</span>
                <span class="stat-value" id="myClassifiedCount">0</span>
              </div>
              <div class="stat-box unclassified clickable" id="myUnclassifiedBox" title="クリックで未分類リスト表示">
                <span class="stat-icon">❓</span>
                <span class="stat-label">未分類</span>
                <span class="stat-value" id="myUnclassifiedCount">0</span>
                <span class="click-hint">▼ 詳細</span>
              </div>
              <div class="stat-box brands">
                <span class="stat-icon">🏷️</span>
                <span class="stat-label">ブランド数</span>
                <span class="stat-value" id="myBrandCount">0</span>
              </div>
            </div>

            <!-- 未分類リスト（クリックで展開） -->
            <div id="myUnclassifiedList" class="unclassified-list" style="display: none;">
              <div class="unclassified-list-header">
                <h4>未分類アイテム一覧</h4>
                <button id="closeMyUnclassifiedList" class="close-list-btn">✕</button>
              </div>
              <div id="myUnclassifiedItems" class="unclassified-items">
                <!-- 動的に生成 -->
              </div>
            </div>

            <!-- AI再判定ボタン（未分類がある場合のみ表示） -->
            <div id="myDataAiSection" class="ai-reclassify-section" style="display: none;">
              <p class="ai-hint">
                <span class="hint-icon">💡</span>
                未分類の商品をAIで自動判定できます
              </p>
              <button id="classifyWithAIBtn" class="ai-classify-btn">
                <span class="btn-icon">🤖</span>
                AIで再判定する
              </button>
              <div id="aiClassifyProgress" class="ai-progress" style="display: none;">
                <div class="progress-bar">
                  <div class="progress-fill" id="aiProgressFill"></div>
                </div>
                <span id="aiProgressText">0/0 判定中...</span>
              </div>
            </div>

            <!-- ブランド別内訳（トップ10） -->
            <div class="brand-breakdown">
              <h4>ブランド別内訳（上位10）</h4>
              <div id="myBrandBreakdown" class="breakdown-list">
                <!-- 動的に生成 -->
              </div>
            </div>

            <!-- 保存アクション -->
            <div class="analysis-save-actions">
              <button id="saveMyDataBtn" class="save-btn">
                <span class="btn-icon">💾</span>
                データを保存
              </button>
              <span class="save-info" id="myDataSaveInfo"></span>
            </div>
          </div>
        </div>

        <!-- AI学習済みルール表示 -->
        <div class="data-section" id="learnedRulesSection">
          <div class="section-header">
            <h2><span class="section-icon">🧠</span> AI学習済みルール</h2>
          </div>
          <div id="learnedRulesContent">
            <!-- 動的に生成 -->
          </div>
        </div>

        <!-- 市場データセクション -->
        <div class="data-section">
          <div class="section-header">
            <h2><span class="section-icon">🌐</span> 市場データ</h2>
          </div>

          <!-- URL入力 -->
          <div class="url-input-group">
            <input type="text" id="ebayUrlInput" class="url-input" placeholder="https://www.ebay.com/sch/... のURLを入力">
            <button id="captureMarketBtn" class="action-btn primary">
              <span class="btn-icon">📡</span>
              取得
            </button>
          </div>
          <p class="input-hint">eBay検索結果ページのURLを入力して市場データを取得</p>

          <!-- 取得結果表示 -->
          <div id="marketCaptureResult" class="capture-result" style="display: none;">
            <span class="added">+<span id="marketAddedCount">0</span>件追加</span>
            <span class="duplicates">(<span id="marketDuplicateCount">0</span>件重複スキップ)</span>
          </div>

          <!-- 市場データサマリー -->
          <div class="data-summary" id="marketDataSummary" style="display: none;">
            <div class="summary-item">
              <span class="summary-label">登録件数</span>
              <span class="summary-value" id="marketTotalCount">0</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">最終更新</span>
              <span class="summary-value small" id="marketLastUpdate">-</span>
            </div>
          </div>

          <!-- 市場データ操作ボタン -->
          <div class="market-data-actions" id="marketDataActions" style="display: none;">
            <button id="analyzeMarketDataBtn" class="action-btn primary">
              <span class="btn-icon">🔍</span>
              分析する
            </button>
            <button id="importMarketCsvBtn" class="action-btn secondary small">
              <span class="btn-icon">📁</span>
              CSV
            </button>
            <button id="clearMarketDataBtn" class="action-btn danger small">
              <span class="btn-icon">🗑️</span>
              データクリア
            </button>
            <button id="clearMarketAnalysisBtn" class="action-btn secondary small">
              <span class="btn-icon">🔄</span>
              分析結果クリア
            </button>
          </div>

          <!-- AI学習済みルール表示（市場データ用）- 常に表示 -->
          <div class="data-section" id="marketLearnedRulesSection">
            <div class="section-header">
              <h4><span class="section-icon">🧠</span> AI学習済みルール</h4>
            </div>
            <div id="marketLearnedRulesContent">
              <!-- 動的に生成 -->
            </div>
          </div>

          <!-- 市場データ分析結果 -->
          <div id="marketDataAnalysisResult" class="data-analysis-result" style="display: none;">
            <div class="analysis-result-header">
              <h3>📊 分析結果</h3>
              <span class="save-status" id="marketDataSaveStatus">
                <span class="save-icon">💾</span>
                <span class="save-text">自動保存済み</span>
              </span>
            </div>
            <div class="analysis-stats">
              <div class="stat-box classified">
                <span class="stat-icon">✅</span>
                <span class="stat-label">分類済み</span>
                <span class="stat-value" id="marketClassifiedCount">0</span>
              </div>
              <div class="stat-box unclassified clickable" id="marketUnclassifiedBox" title="クリックで未分類リスト表示">
                <span class="stat-icon">❓</span>
                <span class="stat-label">未分類</span>
                <span class="stat-value" id="marketUnclassifiedCount">0</span>
                <span class="click-hint">▼ 詳細</span>
              </div>
              <div class="stat-box brands">
                <span class="stat-icon">🏷️</span>
                <span class="stat-label">ブランド数</span>
                <span class="stat-value" id="marketBrandCount">0</span>
              </div>
            </div>

            <!-- 未分類リスト（クリックで展開） -->
            <div id="marketUnclassifiedList" class="unclassified-list" style="display: none;">
              <div class="unclassified-list-header">
                <h4>未分類アイテム一覧</h4>
                <button id="closeMarketUnclassifiedList" class="close-list-btn">✕</button>
              </div>
              <div id="marketUnclassifiedItems" class="unclassified-items">
                <!-- 動的に生成 -->
              </div>
            </div>

            <!-- AI再判定ボタン（未分類がある場合のみ表示） -->
            <div id="marketAiSection" class="ai-reclassify-section" style="display: none;">
              <p class="ai-hint">
                <span class="hint-icon">💡</span>
                未分類のデータをAIで自動判定できます
              </p>
              <button id="classifyMarketWithAIBtn" class="ai-classify-btn">
                <span class="btn-icon">🤖</span>
                AIで再判定する
              </button>
              <div id="marketAiProgress" class="ai-progress" style="display: none;">
                <div class="progress-bar">
                  <div class="progress-fill" id="marketAiProgressFill"></div>
                </div>
                <span id="marketAiProgressText">0/0 判定中...</span>
              </div>
            </div>

            <!-- ブランド別内訳（トップ10） -->
            <div class="brand-breakdown">
              <h4>ブランド別内訳（上位10）</h4>
              <div id="marketBrandBreakdown" class="breakdown-list">
                <!-- 動的に生成 -->
              </div>
            </div>

            <!-- 保存アクション -->
            <div class="analysis-save-actions">
              <button id="saveMarketDataBtn" class="save-btn">
                <span class="btn-icon">💾</span>
                データを保存
              </button>
              <span class="save-info" id="marketDataSaveInfo"></span>
            </div>
          </div>

          <!-- 市場データCSVインポート（hidden） -->
          <input type="file" id="marketCsvFile" accept=".csv" hidden>
        </div>

        <!-- データ保存アクション -->
        <div class="data-actions">
          <button id="saveAllDataBtn" class="action-btn primary full-width">
            <span class="btn-icon">💾</span>
            現在のデータを保存
          </button>
          <p class="action-hint" id="lastSavedInfo">保存済みデータなし</p>
        </div>
      </section>

      <!-- ===================== -->
      <!-- 分析タブ -->
      <!-- ===================== -->
      <section id="analysis-tab" class="tab-content">

        <!-- 自分のデータ分析 -->
        <div class="analysis-section">
          <div class="section-header">
            <h2><span class="section-icon">📈</span> 自分のデータ分析</h2>
          </div>

          <div class="analysis-buttons">
            <button class="analysis-btn" data-analysis="listing-pace">
              <span class="btn-icon">📅</span>
              <span class="btn-label">出品・販売ペース</span>
              <span class="btn-desc">30/60/90日の推移</span>
            </button>
            <button class="analysis-btn" data-analysis="brand-performance">
              <span class="btn-icon">🏷️</span>
              <span class="btn-label">ブランド別</span>
              <span class="btn-desc">ブランド毎の成績</span>
            </button>
            <button class="analysis-btn" data-analysis="watch-analysis">
              <span class="btn-icon">👁️</span>
              <span class="btn-label">Watch数分析</span>
              <span class="btn-desc">注目度の高い商品</span>
            </button>
            <button class="analysis-btn" data-analysis="category-performance">
              <span class="btn-icon">📂</span>
              <span class="btn-label">カテゴリ別</span>
              <span class="btn-desc">カテゴリ毎の成績</span>
            </button>
          </div>
        </div>

        <!-- 市場比較分析 -->
        <div class="analysis-section">
          <div class="section-header">
            <h2><span class="section-icon">🔄</span> 市場比較分析</h2>
            <span id="marketDataCount" class="data-count-badge">市場データ: 0件</span>
          </div>

          <!-- 市場分析サブタブ -->
          <div class="market-subtabs">
            <button class="market-subtab active" data-market-tab="brand-ranking">
              <span>🏆 ブランド</span>
            </button>
            <button class="market-subtab" data-market-tab="category-ranking">
              <span>📁 カテゴリ</span>
            </button>
            <button class="market-subtab" data-market-tab="brand-category">
              <span>🎯 ブランド×カテゴリ</span>
            </button>
            <button class="market-subtab" data-market-tab="comparison">
              <span>⚖️ 自分と比較</span>
            </button>
          </div>

          <!-- 市場分析コンテンツエリア -->
          <div id="marketAnalysisContent" class="market-analysis-content">
            <!-- ブランドランキング -->
            <div id="market-brand-ranking" class="market-tab-content active">
              <div class="ranking-header">
                <h3>🏆 市場ブランドランキング</h3>
                <p class="ranking-desc">市場で売れているブランドTOP30</p>
              </div>
              <div id="brandRankingList" class="ranking-list">
                <p class="no-data-message">市場データを取り込んでください</p>
              </div>
            </div>

            <!-- カテゴリランキング -->
            <div id="market-category-ranking" class="market-tab-content" style="display: none;">
              <div class="ranking-header">
                <h3>📁 市場カテゴリランキング</h3>
                <p class="ranking-desc">市場で売れているカテゴリTOP20</p>
              </div>
              <div id="categoryRankingList" class="ranking-list">
                <p class="no-data-message">市場データを取り込んでください</p>
              </div>
            </div>

            <!-- ブランド×カテゴリ -->
            <div id="market-brand-category" class="market-tab-content" style="display: none;">
              <div class="ranking-header">
                <h3>🎯 ブランド×カテゴリ マトリクス</h3>
                <p class="ranking-desc">ブランドごとのカテゴリ構成</p>
              </div>
              <div id="brandCategoryList" class="ranking-list">
                <p class="no-data-message">市場データを取り込んでください</p>
              </div>
            </div>

            <!-- 自分と比較 -->
            <div id="market-comparison" class="market-tab-content" style="display: none;">
              <div class="ranking-header">
                <h3>⚖️ 市場との比較分析</h3>
                <p class="ranking-desc">自分の出品と市場トレンドを比較</p>
              </div>
              <div id="comparisonContent" class="ranking-list">
                <p class="no-data-message">自分のデータと市場データを両方取り込んでください</p>
              </div>
            </div>
          </div>

          <!-- 市場分析アクションボタン -->
          <div class="market-analysis-actions">
            <button id="loadMarketAnalysisBtn" class="action-btn primary">
              <span class="btn-icon">🔍</span>
              分析を実行
            </button>
            <button id="reanalyzeMarketDataBtn" class="action-btn secondary">
              <span class="btn-icon">🔄</span>
              再判定
            </button>
          </div>
        </div>

        <!-- 分析結果表示エリア -->
        <div id="analysisResultArea" class="analysis-result-area" style="display: none;">
          <div class="result-header">
            <h3 id="analysisResultTitle">分析結果</h3>
            <button id="closeAnalysisResult" class="close-btn">✕</button>
          </div>
          <div id="analysisResultContent" class="result-content">
            <!-- 動的に生成 -->
          </div>
        </div>
      </section>

      <!-- ===================== -->
      <!-- AI提案タブ -->
      <!-- ===================== -->
      <section id="ai-suggestions-tab" class="tab-content">

        <!-- AI選択 -->
        <div class="ai-section">
          <div class="section-header">
            <h2><span class="section-icon">🤖</span> AI選択</h2>
          </div>

          <div class="ai-selector">
            <label class="ai-option">
              <input type="radio" name="aiProvider" value="openai" checked>
              <span class="ai-option-content">
                <span class="ai-logo">🟢</span>
                <span class="ai-name">OpenAI</span>
                <span class="ai-model">GPT-4o</span>
              </span>
            </label>
            <label class="ai-option">
              <input type="radio" name="aiProvider" value="claude">
              <span class="ai-option-content">
                <span class="ai-logo">🟠</span>
                <span class="ai-name">Claude</span>
                <span class="ai-model">Claude 3.5</span>
              </span>
            </label>
            <label class="ai-option">
              <input type="radio" name="aiProvider" value="gemini">
              <span class="ai-option-content">
                <span class="ai-logo">🔵</span>
                <span class="ai-name">Gemini</span>
                <span class="ai-model">Gemini Pro</span>
              </span>
            </label>
            <label class="ai-option compare-all">
              <input type="radio" name="aiProvider" value="compare">
              <span class="ai-option-content">
                <span class="ai-logo">⚡</span>
                <span class="ai-name">全てで比較</span>
                <span class="ai-model">3つのAIで分析</span>
              </span>
            </label>
          </div>

          <!-- API接続状態 -->
          <div class="api-status-bar">
            <div class="api-status-item" id="openaiStatus">
              <span class="status-dot"></span>
              <span>OpenAI</span>
            </div>
            <div class="api-status-item" id="claudeStatus">
              <span class="status-dot"></span>
              <span>Claude</span>
            </div>
            <div class="api-status-item" id="geminiStatus">
              <span class="status-dot"></span>
              <span>Gemini</span>
            </div>
          </div>
        </div>

        <!-- 分析実行 -->
        <div class="ai-section">
          <div class="section-header">
            <h2><span class="section-icon">🎯</span> AI分析を実行</h2>
          </div>

          <div class="ai-analysis-options">
            <label class="checkbox-option">
              <input type="checkbox" id="includeStrengths" checked>
              <span>強み・弱み分析</span>
            </label>
            <label class="checkbox-option">
              <input type="checkbox" id="includePurchasing" checked>
              <span>仕入れ推奨</span>
            </label>
            <label class="checkbox-option">
              <input type="checkbox" id="includePricing" checked>
              <span>価格戦略</span>
            </label>
            <label class="checkbox-option">
              <input type="checkbox" id="includeMarketTrends" checked>
              <span>市場トレンド</span>
            </label>
          </div>

          <button id="runAIAnalysisBtn" class="action-btn primary full-width large">
            <span class="btn-icon">🚀</span>
            総合AI分析を実行
          </button>
        </div>

        <!-- AI分析結果 -->
        <div id="aiResultArea" class="ai-result-area" style="display: none;">
          <div class="ai-result-tabs" id="aiResultTabs">
            <!-- 動的に生成（比較モード時） -->
          </div>
          <div id="aiResultContent" class="ai-result-content">
            <!-- 動的に生成 -->
          </div>
        </div>

        <!-- AIチャット -->
        <div class="ai-section">
          <div class="section-header">
            <h2><span class="section-icon">💬</span> AIに質問</h2>
          </div>

          <div class="chat-container">
            <div id="chatMessages" class="chat-messages">
              <div class="chat-placeholder">
                分析結果について質問できます
              </div>
            </div>
            <div class="chat-input-area">
              <textarea id="chatInput" class="chat-input" placeholder="質問を入力..." rows="2"></textarea>
              <button id="sendChatBtn" class="chat-send-btn">
                <span>➤</span>
              </button>
            </div>
          </div>
        </div>
      </section>

    </main>

    <!-- アラート表示 -->
    <div id="alertContainer" class="alert-container"></div>

    <!-- ローディングオーバーレイ -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
      <div class="loading-spinner"></div>
      <p id="loadingMessage">処理中...</p>
    </div>

    <!-- 分析モーダル -->
    <div id="analysisModal" class="modal-overlay" style="display: none;">
      <div class="modal-container large">
        <div class="modal-header">
          <h2 id="modalTitle">分析</h2>
          <button id="closeModalBtn" class="close-btn">✕</button>
        </div>
        <div id="modalContent" class="modal-content">
          <!-- 動的に生成 -->
        </div>
        <div class="modal-footer">
          <button id="modalActionBtn" class="action-btn primary" style="display: none;">
            実行
          </button>
          <button id="modalCloseBtn" class="action-btn secondary">
            閉じる
          </button>
        </div>
      </div>
    </div>

  </div>

  <script src="chart.min.js"></script>
  <script src="category-rules.js"></script>
  <script src="db.js"></script>
  <script src="analyzer.js"></script>
  <script src="popup.js"></script>
</body>
</html>
